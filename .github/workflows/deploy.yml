name: Deploy Docker Compose App to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      HOSTED_CLICKHOUSE_URL: ${{ secrets.HOSTED_CLICKHOUSE_URL }}
      HOSTED_MYSQL_URL: ${{ secrets.HOSTED_MYSQL_URL }}
      PORT: ${{ secrets.PORT }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # âœ… Clone repo if not already present
          if [ ! -d "/home/ubuntu/cartlow-python-project-prc/.git" ]; then
            echo "Cloning the repository..."
            git clone https://github.com/Uzair-DeVops/cartlow-python-project-prc.git /home/ubuntu/cartlow-python-project-prc
          else
            echo "Repository already exists. Skipping clone."
          fi

          # ğŸ“¥ Pull latest code
          cd /home/ubuntu/cartlow-python-project-prc
          git pull origin main

          # âœ… Create .env file line by line using echo
          echo "HOSTED_MYSQL_URL=${HOSTED_MYSQL_URL}" > .env
          echo "HOSTED_CLICKHOUSE_URL=${HOSTED_CLICKHOUSE_URL}" >> .env
          echo "SENTRY_DSN=${SENTRY_DSN}" >> .env
          echo "PORT=${PORT}" >> .env

          # ğŸ³ Rebuild and restart Docker
          sudo docker-compose down
          sudo docker-compose build
          sudo docker-compose up -d
