name: Deploy Docker Compose App to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      HOSTED_CLICKHOUSE_URL: ${{ secrets.HOSTED_CLICKHOUSE_URL }}
      HOSTED_MYSQL_URL: ${{ secrets.HOSTED_MYSQL_URL }}
      PORT: ${{ secrets.PORT }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # ‚úÖ Clone repo if not already present
          if [ ! -d "/home/ubuntu/cartlow-python-project-prc/.git" ]; then
            echo "Cloning the repository..."
            git clone https://github.com/lukecartlow/cartlow-python-project-prc.git /home/ubuntu/cartlow-python-project-prc
          else
            echo "Repository already exists. Skipping clone."
          fi

          # üì• Pull latest code
          cd /home/ubuntu/cartlow-python-project-prc
          git pull origin main

          # üîê Write secrets into .env
          cat <<EOF > .env
HOSTED_CLICKHOUSE_URL=${HOSTED_CLICKHOUSE_URL}
HOSTED_MYSQL_URL=${HOSTED_MYSQL_URL}
PORT=${PORT}
SENTRY_DSN=${SENTRY_DSN}
EOF

          # üê≥ Rebuild and restart the Docker Compose stack
          sudo docker-compose down
          sudo docker-compose build
          sudo docker-compose up -d
